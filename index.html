<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0b0d12">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Raiki">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <title>山元 来輝 | Raiki Yamamoto</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="images/Raiki.jpg" type="image/jpeg">
    <link rel="manifest" href="manifest.json">
  </head>
  <body>
    <div id="save-options-modal" class="modal-overlay" style="display:none;">
      <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="save-modal-title">
        <p class="modal-title" id="save-modal-title">保存方法を選択</p>
        
        <div class="modal-actions">
          <a id="save-vcard-link" href="#" class="modal-button"><img src="images/連絡先.png" alt="連絡先" class="modal-icon">連絡先に保存</a>

          <a id="mail-self-link" href="#" class="modal-button"><img src="images/メール.png" alt="メール" class="modal-icon">メールを自分に送信</a>

          <button id="add-to-home-screen-button" class="modal-button">ホーム画面に追加</button>
        </div>
        <button id="close-modal-button" class="modal-close-button" aria-label="戻る">戻る</button>
      </div>
    </div>
    <header class="site-header">
      <div class="hero">
        <div class="hero-inner">
          <img class="hero-avatar" src="images/Raiki.jpg" alt="プロフィール写真">
        </div>
      </div>
    </header>
    <section class="identity-block" aria-label="プロフィール概要">
      <h1 class="identity-name">山元 来輝<span class="latin">Raiki Yamamoto</span></h1>
      <p class="identity-title">Lotus Card 共同CEO</p>
      <p class="identity-subtitle">Leverages U.S. DX Technician</p>
    </section>
    <main class="card" role="main">
      <section class="intro" aria-label="自己紹介">
        <h2 class="intro-title">About me</h2>
        <p>20歳起業家</p>
        <p>アメリカ大学2年間留学→起業するため中退</p>
        <p>趣味: サッカー、ピアノ、旅行</p>
        <p><strong>ビジョン:</strong> まだ見ぬ世界へ</p>
      </section>

      <section class="sns" aria-label="SNS リンク">
        <div class="sns-grid">
          <a class="sns-btn" href="https://www.instagram.com/raiki_aer/" target="_blank" rel="noopener" aria-label="Instagram">
            <img src="images/Instagram.png" alt="Instagram">
            <span class="label">Instagram</span>
          </a>
          <a class="sns-btn" href="https://www.linkedin.com/in/raiki-yamamoto-047106277/" target="_blank" rel="noopener" aria-label="LinkedIn">
            <img src="images/LinkedIn画像.png" alt="LinkedIn">
            <span class="label">LinkedIn</span>
          </a>
          <a class="sns-btn" href="https://note.com/raiki4416" target="_blank" rel="noopener" aria-label="note">
            <img src="images/Note画像.webp" alt="note">
            <span class="label">note</span>
          </a>
          <a class="sns-btn" href="mailto:soccer.6.yama6@gmail.com" aria-label="Email">
            <img src="images/Mail画像.png" alt="Email">
            <span class="label">Email</span>
          </a>
        </div>
      </section>

      <section class="share-section" aria-label="共有・保存">
        <div class="share-buttons">
          <button class="share-btn" id="shareBtn">
            <span>共有</span>
          </button>
          <button class="install-btn" id="open-save-modal-button">
            <span>情報の保存</span>
          </button>
        </div>
      </section>

      <section class="schedule" aria-label="日程調整">
        <p>オンラインでお話ししませんか？</p>
        <p><a href="https://calendly.com/soccer-6-yama6/30min" target="_blank" rel="noopener">スケジュール調整</a></p>
      </section>
    </main>

    <footer class="footer">
      <small>© <span id="year"></span> Raiki Yamamoto</small>
    </footer>

    <script>
      document.getElementById('year').textContent = new Date().getFullYear()

      // PWA Service Worker Registration
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then((registration) => {
              console.log('SW registered: ', registration);
            })
            .catch((registrationError) => {
              console.log('SW registration failed: ', registrationError);
            });
        });
      }

      // Web Share API and Add to Home Screen
      const shareBtn = document.getElementById('shareBtn');
      const openSaveModalBtn = document.getElementById('open-save-modal-button');
      const saveModal = document.getElementById('save-options-modal');
      const closeModalBtn = document.getElementById('close-modal-button');
      const addToHomeBtn = document.getElementById('add-to-home-screen-button');
      const mailSelfLink = document.getElementById('mail-self-link');
      const saveVcardLink = document.getElementById('save-vcard-link');
      let deferredPrompt;
      
      // Listen for the beforeinstallprompt event
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
      });

      // Share button functionality
      shareBtn.addEventListener('click', shareProfile);

      // Open modal
      openSaveModalBtn.addEventListener('click', () => {
        saveModal.style.display = 'flex';
      });

      // Close modal by button
      closeModalBtn.addEventListener('click', () => {
        saveModal.style.display = 'none';
      });

      // Close modal by clicking overlay
      saveModal.addEventListener('click', (e) => {
        if (e.target === saveModal) {
          saveModal.style.display = 'none';
        }
      });

      // Migrate original install logic to modal button
      addToHomeBtn.addEventListener('click', () => {
        saveModal.style.display = 'none';
        showInstallInstructions();
      });

      // Build and download vCard with dynamic name and photo
      saveVcardLink.addEventListener('click', async (e) => {
        e.preventDefault();

        // Extract Japanese name from heading
        const identityEl = document.querySelector('.identity-name');
        let ownerNameJa = '名刺の持ち主';
        if (identityEl) {
          const cloned = identityEl.cloneNode(true);
          const latin = cloned.querySelector('.latin');
          if (latin) latin.remove();
          ownerNameJa = (cloned.textContent || '').trim();
        }

        const ownerNameEn = (document.querySelector('.identity-name .latin')?.textContent || '');
        const email = 'soccer.6.yama6@gmail.com';
        const org = 'Lotus Card';
        const title = '共同CEO';
        const website = window.location.origin + window.location.pathname;
        const photoUrl = document.querySelector('.hero-avatar')?.getAttribute('src') || 'images/Raiki.jpg';

        // Fetch and base64 encode the photo for embedding
        async function fetchAsBase64(url) {
          try {
            const res = await fetch(url, { mode: 'cors' });
            const blob = await res.blob();
            return await new Promise((resolve) => {
              const reader = new FileReader();
              reader.onloadend = () => resolve(reader.result.split(',')[1]);
              reader.readAsDataURL(blob);
            });
          } catch (e) {
            return '';
          }
        }

        const base64Photo = await fetchAsBase64(photoUrl);

        // Attempt to split name into family/given (simple heuristic)
        let family = '', given = ownerNameJa;
        if (ownerNameJa.includes(' ')) {
          const parts = ownerNameJa.split(' ');
          family = parts[0];
          given = parts.slice(1).join(' ');
        }

        const lines = [
          'BEGIN:VCARD',
          'VERSION:3.0',
          `FN:${ownerNameJa}${ownerNameEn ? ' / ' + ownerNameEn : ''}`,
          `N:${family};${given};;;`,
          `ORG:${org}`,
          `TITLE:${title}`,
          `EMAIL:${email}`,
          `URL:${website}`,
          base64Photo ? `PHOTO;ENCODING=b;TYPE=JPEG:${base64Photo}` : `PHOTO;VALUE=URI:${new URL(photoUrl, location.href).href}`,
          'END:VCARD'
        ];

        const vcard = lines.join('\r\n');
        const blob = new Blob([vcard], { type: 'text/vcard;charset=utf-8' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        const safeName = ownerNameEn || ownerNameJa || 'contact';
        a.href = url;
        a.download = `${safeName.replace(/\s+/g, '_')}.vcf`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });

      

      // Handle "メールを自分に送信" dynamically to set recipient
      mailSelfLink.addEventListener('click', (e) => {
        e.preventDefault();
        // Open mail composer without preset recipient

        const subject = '【Lotus Card】Raiki Yamamoto様の連絡先';

        // 名刺の持ち主の日本語名を見出しから取得（英字は除外）
        const identityEl = document.querySelector('.identity-name');
        let ownerNameJa = '名刺の持ち主';
        if (identityEl) {
          const cloned = identityEl.cloneNode(true);
          const latin = cloned.querySelector('.latin');
          if (latin) latin.remove();
          ownerNameJa = (cloned.textContent || '').trim();
        }

        const body = [
          'Lotus Card 共同CEOのRaiki Yamamoto様の連絡先です。',
          '',
          '✉️ 宛先（To）にご自身のメールアドレスを入力してから送信してください。',
          `数十秒で${ownerNameJa}さんのLotusCard情報が保存され、いつでもメールから見返せます☺️`,
          '',
          '---',
          '名前: Raiki Yamamoto',
          '会社名: Lotus Card',
          '役職: 共同CEO',
          'メール: soccer.6.yama6@gmail.com',
          'ウェブサイト: https://raiki-ver-2.vercel.app/',
          '---'
        ].join('\n');

        const mailto = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        window.location.href = mailto;
      });

      function showInstallInstructions() {
        const instructions = [
          'ホーム画面に追加する手順',
          '',
          '【iPhone/iPadの場合】',
          'Safariでウェブサイトを開く',
          '画面下部（または上部）の「共有」アイコンをタップ',
          '「ホーム画面に追加」を選択',
          '「追加」をタップ',
          '',
          '【Androidの場合 (Chrome)】',
          'Chromeでウェブサイトを開く',
          '右上の「︙」メニューをタップ',
          '「ホーム画面に追加」を選択',
          '画面の指示に従い「追加」をタップ'
        ].join('\n');
        alert(instructions);
      }
      
      async function shareProfile() {
        const shareData = {
          title: '山元 来輝 - Lotus Card 共同CEO',
          text: 'Lotus Card 共同CEOのプロフィールをご覧ください',
          url: window.location.href
        };

        try {
          if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
            await navigator.share(shareData);
          }
        } catch (err) {
          console.error('Error sharing: ', err);
          // Silent fail - no alert message
        }
      }

    </script>
  </body>
  </html>


